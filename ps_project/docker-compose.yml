version: "3.9"

services:
  db:
    build:
      context: ./backend/database
    env_file:
      - ./.env
    environment:
      MYSQL_ROOT_PASSWORD: ${DOCKER_DB_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
      - ./backend/database/dump.sql:/docker-entrypoint-initdb.d/dump.sql:ro
      - ./backend/database/setup.sh:/docker-entrypoint-initdb.d/setup.sh:ro
    ports:
      - "${DB_PORT:-3306}:3306"
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p$DOCKER_DB_PASSWORD"]
      interval: 5s
      timeout: 5s
      retries: 15
    restart: unless-stopped

  backend:
    build:
      context: ./backend
    env_file:
      - ./.env
      - ./.env.local
      - ./.env.development.local
    environment:
      DB_HOST: db
      DB_PORT: ${DB_PORT:-3306}
      DEV_AUTH_BYPASS: ${DEV_AUTH_BYPASS}
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./backend:/app
      - ./backend/upload:/app/upload
      - ./.env:/app/.env:ro
      - ./.env.local:/app/.env.local:ro
      - ./.env.development.local:/app/.env.development.local:ro
    ports:
      - "${DOCKER_APP_PUBLISHED_PORT:-8080}:${DOCKER_APP_PORT:-8080}"
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
    env_file:
      - ./.env
    environment:
      BACKEND_URL: http://backend:${DOCKER_APP_PORT:-8080}
      API_BASE_URL: http://backend:${DOCKER_APP_PORT:-8080}
    depends_on:
      backend:
        condition: service_started
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    ports:
      - "3000:3000"
    command: sh -c "npm install && npm run dev -- --hostname 0.0.0.0 --port 3000"
    restart: unless-stopped

  react-admin:
    build:
      context: ./react-admin
    env_file:
      - ./.env
    depends_on:
      backend:
        condition: service_started
    volumes:
      - ./react-admin:/app
      - react_admin_node_modules:/app/node_modules
    ports:
      - "3001:3000"
    command: sh -c "npm install && npm start"
    profiles:
      - admin
    restart: unless-stopped

volumes:
  db_data:
  frontend_node_modules:
  react_admin_node_modules:
